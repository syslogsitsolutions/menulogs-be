name: Deploy Backend

on:
  push:
    branches:
      - main      # Production deployments
      - develop   # Development deployments

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: menulogs-backend

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_PROD_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_DEV_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          # Get version from package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          GIT_COMMIT=$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # Create version tags
          VERSION_TAG="v${PACKAGE_VERSION}-$(date +%Y%m%d)-${GIT_COMMIT}"
          PROD_TAG="prod-$(date +%Y%m%d-%H%M%S)"
          
          echo "ðŸ“¦ Building with version tags:"
          echo "   Package Version: ${PACKAGE_VERSION}"
          echo "   Version Tag: ${VERSION_TAG}"
          echo "   Prod Tag: ${PROD_TAG}"
          echo "   Environment Tag: ${IMAGE_TAG}"
          
          # Build Docker image with version metadata
          docker build \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg BUILD_VERSION="${VERSION_TAG}" \
            --build-arg PACKAGE_VERSION="${PACKAGE_VERSION}" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          # Push all tags
          echo "ðŸš€ Pushing images to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Set outputs for deployment
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "prod_tag=${PROD_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ env.EC2_HOST }}
          EC2_USER: ${{ env.EC2_USER }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            # Login to ECR
            aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com
            
            # Navigate to deployment directory
            cd /opt/menulogs/${{ env.ENVIRONMENT }}
            
            # Pull latest image
            docker-compose pull backend
            
            # Regenerate Prisma Client (needed after Prisma 7 upgrade)
            echo "ðŸ”„ Regenerating Prisma Client..."
            docker-compose run --rm -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 backend npx prisma generate
            
            # Run database migrations BEFORE restarting
            # This ensures migrations are applied before the new code runs
            echo "ðŸ”„ Running database migrations..."
            docker-compose run --rm -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 backend npx prisma migrate deploy
            
            # Verify migrations status
            docker-compose run --rm backend npx prisma migrate status || true
            
            # Restart backend service
            docker-compose up -d backend
            
            # Check health
            sleep 10
            curl -f http://localhost:5000/health || exit 1
            
            echo "âœ… Deployment successful!"
          ENDSSH

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ steps.build-image.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Tag:** ${{ steps.build-image.outputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prod Tag:** ${{ steps.build-image.outputs.prod_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

