name: Deploy Backend

on:
  push:
    branches:
      - main
      - develop

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: menulogs-backend

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_PROD_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_DEV_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          GIT_COMMIT=$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          VERSION_TAG="v${PACKAGE_VERSION}-$(date +%Y%m%d)-${GIT_COMMIT}"
          PROD_TAG="prod-$(date +%Y%m%d-%H%M%S)"
          
          echo "Building image: ${VERSION_TAG}"
          
          docker build \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg BUILD_VERSION="${VERSION_TAG}" \
            --build-arg PACKAGE_VERSION="${PACKAGE_VERSION}" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ env.EC2_HOST }}
          EC2_USER: ${{ env.EC2_USER }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          IMAGE_URL: ${{ steps.build-image.outputs.image }}
          VERSION_TAG: ${{ steps.build-image.outputs.version_tag }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'DEPLOY_SCRIPT'
            set -euo pipefail
            
            IMAGE_URL="${IMAGE_URL}"
            ENVIRONMENT="${ENVIRONMENT}"
            ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com"
            
            echo "Logging in to ECR..."
            aws ecr get-login-password --region ap-south-1 | \
              docker login --username AWS --password-stdin ${ECR_REGISTRY}
            
            cd /opt/menulogs/${ENVIRONMENT}
            
            echo "Updating docker-compose.yml..."
            if [ ! -f docker-compose.yml ]; then
              echo "Error: docker-compose.yml not found"
              exit 1
            fi
            
            cp docker-compose.yml docker-compose.yml.backup.$(date +%s)
            sed -i "s|image:.*menulogs-backend[^[:space:]]*|image: ${IMAGE_URL}|g" docker-compose.yml
            
            echo "Pulling image..."
            docker-compose pull backend
            
            echo "Stopping existing container..."
            docker-compose stop backend || true
            docker-compose rm -f backend || true
            
            echo "Regenerating Prisma Client..."
            docker-compose run --rm \
              -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 \
              backend npx prisma generate || true
            
            echo "Running database migrations..."
            docker-compose run --rm \
              -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 \
              backend npx prisma migrate deploy || true
            
            echo "Starting container..."
            docker-compose up -d --force-recreate backend
            
            echo "Waiting for container to start..."
            sleep 10
            
            if ! docker-compose ps backend | grep -q "Up"; then
              echo "Error: Container failed to start"
              docker-compose logs --tail=50 backend
              exit 1
            fi
            
            echo "Checking health endpoint..."
            for i in {1..10}; do
              if curl -f -s http://localhost:5000/health > /dev/null 2>&1; then
                echo "Health check passed"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "Warning: Health check failed after 10 attempts"
                docker-compose logs --tail=30 backend
              else
                sleep 3
              fi
            done
            
            RUNNING_IMAGE=$(docker inspect $(docker-compose ps -q backend) --format='{{.Config.Image}}' 2>/dev/null)
            echo "Deployed image: ${RUNNING_IMAGE}"
          DEPLOY_SCRIPT

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ steps.build-image.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.build-image.outputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
