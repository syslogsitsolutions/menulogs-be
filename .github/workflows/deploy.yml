name: Deploy Backend

on:
  push:
    branches:
      - main      # Production deployments
      - develop   # Development deployments

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: menulogs-backend

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_PROD_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.EC2_DEV_HOST }}" >> $GITHUB_ENV
            echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          # Get version from package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          GIT_COMMIT=$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # Create version tags
          VERSION_TAG="v${PACKAGE_VERSION}-$(date +%Y%m%d)-${GIT_COMMIT}"
          PROD_TAG="prod-$(date +%Y%m%d-%H%M%S)"
          
          echo "ðŸ“¦ Building with version tags:"
          echo "   Package Version: ${PACKAGE_VERSION}"
          echo "   Version Tag: ${VERSION_TAG}"
          echo "   Prod Tag: ${PROD_TAG}"
          echo "   Environment Tag: ${IMAGE_TAG}"
          
          # Build Docker image with version metadata
          docker build \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg BUILD_VERSION="${VERSION_TAG}" \
            --build-arg PACKAGE_VERSION="${PACKAGE_VERSION}" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          # Push all tags
          echo "ðŸš€ Pushing images to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${PROD_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Set outputs for deployment
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "prod_tag=${PROD_TAG}" >> $GITHUB_OUTPUT

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ env.EC2_HOST }}
          EC2_USER: ${{ env.EC2_USER }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          IMAGE_URL: ${{ steps.build-image.outputs.image }}
          VERSION_TAG: ${{ steps.build-image.outputs.version_tag }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << EOF
            set -e
            set -x  # Enable command tracing for debugging
            
            # Set variables from GitHub Actions environment
            IMAGE_URL="${IMAGE_URL}"
            VERSION_TAG="${VERSION_TAG}"
            ENVIRONMENT="${ENVIRONMENT}"
            export IMAGE_URL VERSION_TAG ENVIRONMENT
            
            echo "ðŸ“¦ Image URL: \${IMAGE_URL}"
            echo "ðŸ“¦ Version Tag: \${VERSION_TAG}"
            echo "ðŸ“¦ Environment: \${ENVIRONMENT}"
            
            # Login to ECR
            aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com
            
            # Navigate to deployment directory
            cd /opt/menulogs/\${ENVIRONMENT}
            
            # Force pull the specific version tag (not just 'latest' or 'prod')
            echo "ðŸ“¥ Pulling specific version: \${IMAGE_URL}"
            docker pull \${IMAGE_URL} || {
              echo "âš ï¸  Failed to pull \${IMAGE_URL}, trying with environment tag..."
              docker pull ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
              IMAGE_URL="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
              export IMAGE_URL
            }
            
            # Also pull latest tag to ensure it's updated
            docker pull ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest || true
            
            # Stop and remove old container to force recreation
            echo "ðŸ›‘ Stopping old container..."
            docker-compose stop backend || true
            docker-compose rm -f backend || true
            
            # Update docker-compose.yml to use the specific version tag
            # This ensures we deploy the exact version that was built
            if [ -f docker-compose.yml ]; then
              echo "ðŸ“ Updating docker-compose.yml with version tag..."
              # Backup original
              cp docker-compose.yml docker-compose.yml.backup.$(date +%s) || true
              
              # Update image tag - try multiple patterns
              # Pattern 1: image: repo/menulogs-backend:tag
              sed -i.tmp "s|image:.*menulogs-backend[^[:space:]]*|image: \${IMAGE_URL}|g" docker-compose.yml || true
              # Pattern 2: image: repo/backend:tag  
              sed -i.tmp "s|image:.*/backend[^[:space:]]*|image: \${IMAGE_URL}|g" docker-compose.yml || true
              # Clean up temp file
              rm -f docker-compose.yml.tmp || true
              
              echo "âœ… Updated docker-compose.yml"
              echo "   New image: \${IMAGE_URL}"
              
              # Verify the update worked
              echo "ðŸ” Verifying docker-compose.yml update:"
              grep "image:" docker-compose.yml | grep backend || grep "image:" docker-compose.yml
            else
              echo "âš ï¸  docker-compose.yml not found!"
              exit 1
            fi
            
            # Pull the specific image version using docker-compose
            # This ensures docker-compose uses the updated image tag
            echo "ðŸ“¥ Pulling image using docker-compose..."
            docker-compose pull backend
            
            # Verify the image was pulled
            echo "ðŸ” Verifying image pull:"
            docker images | grep menulogs-backend | head -3
            
            # Regenerate Prisma Client (needed after Prisma 7 upgrade)
            echo "ðŸ”„ Regenerating Prisma Client..."
            docker-compose run --rm -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 backend npx prisma generate
            
            # Run database migrations BEFORE restarting
            # This ensures migrations are applied before the new code runs
            echo "ðŸ”„ Running database migrations..."
            docker-compose run --rm -e PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 backend npx prisma migrate deploy
            
            # Verify migrations status
            docker-compose run --rm backend npx prisma migrate status || true
            
            # Force recreate the container with the new image
            # This ensures the updated docker-compose.yml is used
            echo "ðŸš€ Starting backend with new image..."
            
            # Stop and remove first to ensure clean start
            docker-compose stop backend || true
            docker-compose rm -f backend || true
            
            # Start the container (this will pull if needed and create new container)
            docker-compose up -d --force-recreate backend
            
            # Wait a moment for container to start
            sleep 5
            
            # Verify container is running
            echo "ðŸ” Checking container status:"
            docker-compose ps backend
            
            # Verify container is actually running
            if ! docker-compose ps backend | grep -q "Up"; then
              echo "âŒ Container failed to start!"
              echo "ðŸ“‹ Container logs:"
              docker-compose logs backend
              exit 1
            fi
            
            # Verify the container is using the correct image
            echo "ðŸ” Verifying deployed image..."
            DEPLOYED_IMAGE=\$(docker inspect \$(docker-compose ps -q backend) --format='{{.Config.Image}}' 2>/dev/null || echo "unknown")
            echo "   Deployed image: \${DEPLOYED_IMAGE}"
            echo "   Expected image: \${IMAGE_URL}"
            
            # Check health
            echo "ðŸ¥ Checking health..."
            sleep 10
            for i in {1..6}; do
              if curl -f http://localhost:5000/health; then
                echo "âœ… Health check passed!"
                break
              else
                echo "â³ Health check attempt \$i/6 failed, retrying..."
                sleep 5
              fi
            done
            
            # Final verification - check logs for version info
            echo "ðŸ“‹ Container logs (last 20 lines):"
            docker-compose logs --tail=20 backend || true
            
            echo "âœ… Deployment successful!"
          EOF

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ steps.build-image.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Tag:** ${{ steps.build-image.outputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prod Tag:** ${{ steps.build-image.outputs.prod_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

